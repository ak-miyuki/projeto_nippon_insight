<!DOCTYPE html>
<html lang="pt-br">

<head>
    <!-- <link rel="shortcut icon" href="../assets/icons/mt_fuji_img.png" type="image/x-icon"> -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>『日本』Nippon Insight | Dashboards</title>


    <link rel="stylesheet" href="./../css/dashboards.css">
    <!-- <link rel="stylesheet" href="./../css/estilo.css" /> -->
    <link rel="stylesheet" href="./../css/style.css" />

    <script src="../js/sessao.js"></script>
    <!-- <script src="./../js/alerta.js"></script> -->


    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


    <!--FONT AWESOME-->
    <!--  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script> -->

</head>

<!-- <body onload=" atualizarFeed()"> -->

<body onload="atualizarPagina()">

    <!------------------------------- HEADER ------------------------------->
    <div class="header">
        <div class="container">
            <h1 class="titulo">『日本』Nippon Insight</h1>
            <ul class="navbar">
                <li class="agora">
                    <a href="#">DASHBOARD</a>
                </li>
                <li> | </li>
                <li>
                    <a href="./viagem.html">EDITAR VIAGEM</a>
                </li>
                <li> | </li>
                <li>
                    <a href="./escolhas.html">ESCOLHAS</a>
                </li>

            </ul>
            <div class="nome-sair">
                <div class="hello">
                    <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
                </div>
                <div>
                    <button class="botao-preto" onclick="limparSessao()">SAIR</button>
                </div>
            </div>

        </div>
    </div>
    <!----------------------------- HEADER END ----------------------------->

    <div class="janela">
        <div class="header-left">
            <div class="menu_titulo">
                <h1>SUA VIAGEM</h1>
            </div>

            <div class="conteudo">
                <!-- COLOCAR OS CONTEÚDOS DO MENU -->
                <!-- DATA DE IDA -->
                <div class="menu_block">
                    <h3>&#x1F338; Data de ida</h3>
                    <span id="span_dt_ida"> --//-- </span>
                </div>

                <!-- DATA DE VOLTA -->
                <div class="menu_block">
                    <h3>&#x1F338; Data de volta:</h3>
                    <span id="span_dt_volta"> --//-- </span>
                </div>

                <!-- HORAS DE VÔO -->
                <div class="menu_block">
                    <h3>&#x1F338; Horas de vôo:</h3>
                    <span id="span_horas_voo"> --//-- </span>
                </div>

                <!-- DIAS NO JAPÃO -->
                <div class="menu_block">
                    <h3>&#x1F338; Dias no Japão:</h3>
                    <span id="span_dias_japao"> --//-- </span>
                </div>

                <!-- QUANTIDADE DE PESSOAS -->
                <div class="menu_block">
                    <h3>&#x1F338; Quantidade de pessoas:</h3>
                    <span id="span_qtd_pessoas"> --//-- </span>
                </div>

                <!-- ATUALIZAR CAIXINHA -->
                <div class="menu_block_ultimo">
                    <h3>&#x1F338; Valor à Adicionar/Retirar:</h3>
                    <input type="number" id="caixinha_input" placeholder="R$">
                    <button class="botao" onclick="atualizarCaixinha()">ATUALIZAR CAIXINHA</button>
                </div>

            </div>

        </div>

        <div class="dash">
            <div class="kpi_bar">
                <!-- estação -->
                <div class="kpi_black">
                    <div class="kpi">
                        <h3>ESTAÇÃO ESCOLHIDA</h3>
                        <span id="span_estacao">--//--</span>
                    </div>
                </div>

                <!-- cotação -->
                <div class="kpi_black">
                    <div class="kpi">
                        <h3>COTAÇÃO ¥ / R$</h3>
                        <span id="span_cotacao">--//--</span>
                    </div>
                </div>

                <!-- valor total da viagem -->
                <div class="kpi_black">
                    <div class="kpi">
                        <h3>VALOR DA VIAGEM</h3>
                        <span id="span_valor_viagem">--//--</span>
                    </div>
                </div>

                <!-- valor guardado -->
                <div class="kpi_black">
                    <div class="kpi">
                        <h3>VALOR GUARDADO</h3>
                        <span id="span_valor_guardado">--//--</span>
                    </div>
                </div>
            </div>

            <div class="graficos_todos">
                <!-- gráfico de barras -->
                <div class="grafico_esquerda">
                    <div class="titulo_grafico">LOCAIS MAIS VOTADOS</div>
                    <div class="container">

                        <!-- GRÁFICO DE BARRAS -->
                        <canvas id="grafico_barras" width="400px" height="370px"></canvas>
                    </div>

                </div>
                <div class="graficos_direita">
                    <div class="grafico_progresso">
                        <div class="titulo_grafico">PERCENTUAL DO VALOR GUARDADO</div>
                        <div class="barra_porcentagem">
                            <div class="bg_bege">
                                <div class="bg_dourado" id="barra_porcentagem"> <!-- varia conforme % -->

                                </div>
                            </div>
                            <div class="porcentagem">
                                <h3 id="porcentagem_progresso">%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="grafico_pizza" id="div_grafico_pizza">
                        <div class="titulo_grafico">GASTOS POR CATEGORIA</div>
                        <div class="container" id="div_container_pizza">
                            <!-- Gráfico de pizza -->
                            <canvas id="grafico_pizza" width="400px" height="400px"></canvas>

                        </div>


                    </div>
                </div>

            </div>


        </div>
    </div>


</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    var BRL = 1;
    var JPY = 28.77;
    span_cotacao.innerHTML = `BRL ${BRL.toFixed(2)} = JPY ${JPY.toFixed(2)}`;
    var valorTotal = 0;
    var valor_guardado = 0;

    var idViagem = sessionStorage.ID_VIAGEM;
    console.log(`Esse é o idViagem: `, idViagem);

    if (idViagem == 'null') {
        fetch(`/viagem/${sessionStorage.ID_USUARIO}`)
            .then(function (resposta) {
                // console.log(`resposta.json(): `, resposta.json)

                resposta.json()
                    .then(function (respostaJson) {
                        sessionStorage.ID_VIAGEM = JSON.stringify(respostaJson.idViagem);
                    })
            });

    }

    function atualizarPagina() {

        var horas_voo = 50;
        span_horas_voo.innerHTML = `~${horas_voo} HORAS`;


        fetch(`/viagem/${sessionStorage.ID_USUARIO}`)
            .then(response => response.json())
            .then(listaViagem => {

                if (listaViagem.length === 0) {
                    alert("errinho");
                } else {
                    if (idViagem == undefined) {
                        idViagem = listaViagem[0].idViagem;
                    }
                    console.log('idViagem após fetch = ', idViagem);

                    span_estacao.innerHTML = listaViagem[0].estacao;
                    span_dt_ida.innerHTML = listaViagem[0].dtIda;
                    span_dt_volta.innerHTML = listaViagem[0].dtVolta;
                    span_dias_japao.innerHTML = listaViagem[0].diasJapao;

                    var qtd_pessoas = Number(listaViagem[0].qtdPessoas);
                    span_qtd_pessoas.innerHTML = qtd_pessoas

                    valor_guardado = Number(listaViagem[0].valorGuardado);
                    span_valor_guardado.innerHTML = valor_guardado.toLocaleString('pt-BR', { style: "currency", currency: 'BRL' });

                    valorTotal = Number(listaViagem[0].valorTotal);
                    var valorMultiPessoas = valorTotal * qtd_pessoas;
                    span_valor_viagem.innerHTML = valorMultiPessoas.toLocaleString('pt-BR', { style: "currency", currency: 'BRL' });

                    var progresso = listaViagem[0].percentualGuardado;

                    porcentagem_progresso.innerHTML = `${progresso}%`;

                    if (progresso > 100) {
                        progresso = 100
                    }
                    barra_porcentagem.style.width = `${progresso}%`;
                }

                obterDadosGraficoPizza();
                obterDadosGraficoBarras();
            })
            .catch(error => console.error('Erro ao buscar dados:', error));

    }

    function obterDadosGraficoPizza() {

        fetch(`/escolhas/${idViagem}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();

                        plotarGraficoPizza(resposta, idViagem);

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico de pizza: ${error.message}`);
            });
    }


    function plotarGraficoPizza(resposta, idViagem) {

        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = 'Montserrat';
        Chart.defaults.color = '#e3b062';

        console.log('iniciando plotagem do gráfico de pizza...');

        var categorias = [];
        var valores = [];
        var valorSomaTotal = 0;

        for (var i = 0; i < resposta.length; i++) {
            categorias.push(resposta[i].categoria);
            valores.push(Number(resposta[i].valorTotal));
            valorSomaTotal += Number(resposta[i].valorTotal);

        }

        if (categorias.length > 0) {
            div_container_pizza.style.display = "block"
        }

        var config = {
            type: 'pie',
            data: {
                labels: categorias,
                datasets: [{
                    data: valores,
                    backgroundColor: [
                        '#4d0a1c',
                        '#bd6088',
                        '#dfd4be',
                        '#9f3254',
                        '#e3b062'

                    ],
                    borderColor: '#c4b28b',
                    borderWidth: 2
                }]
            },

            options: {
                responsive: true,
                aspectRatio: 1.2,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    datalabels: {
                        color: '#dfd4be', // Cor do texto da porcentagem (branco é bom para fundos escuros)
                        font: {
                            weight: 'bold',
                            size: 14
                        },
                        formatter: (valor, context) => {
                            var porcentagem = (valor / valorSomaTotal) * 100;

                            return porcentagem.toFixed(2) + '%';
                        },
                        anchor: 'end',
                        align: 'end',
                        offset: 10
                    }
                }
            }
        };

        let myChart = new Chart(document.getElementById("grafico_pizza"), config);
    }

    function obterDadosGraficoBarras() {

        fetch(`/escolhas/buscarVotosLugares`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();

                        plotarGraficoBarras(resposta);

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico de barra: ${error.message}`);
            });
    }

    function plotarGraficoBarras(resposta) {

        Chart.defaults.font.family = 'Montserrat';
        Chart.defaults.color = '#e3b062';

        console.log('iniciando plotagem do gráfico de barra...');

        var lugares = [];
        var votos = [];

        for (var i = 0; i < resposta.length; i++) {
            lugares.push(resposta[i].lugar);
            votos.push(resposta[i].votos);
        }

        if (lugares.length > 0) {
            grafico_barras.style.display = "block"
        }

        var config = {
            type: 'bar',
            data: {
                labels: lugares,
                datasets: [{
                    barPercentage: 1,
                    categoryPercentage: 0.7,
                    maxBarThickness: 45,
                    data: votos,
                    indexAxis: 'y',

                    backgroundColor: [
                        '#4d0a1c',
                        '#bd6088',
                        '#dfd4be',
                        '#9f3254',
                        '#e3b062'

                    ],
                    borderColor: '#c4b28b',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: 3,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        };

        let myChart = new Chart(document.getElementById("grafico_barras"), config);
    }







    function atualizarCaixinha() {

        var novoValorGuardadoVar = valor_guardado;
        var caixinha = Number(caixinha_input.value);

        novoValorGuardadoVar += caixinha;

        // enviar ao banco
        fetch("/viagem/atualizarCaixinha", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                novoValorGuardadoServer: novoValorGuardadoVar,
                idUsuarioServer: sessionStorage.ID_USUARIO
            }),
        })
            .then(function (resposta) {

                setTimeout(() => {

                    atualizarPagina();
                }, "2000");

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    cardErro.style.display = "block";

                    mensagem_erro.innerHTML =
                        "Caixinha atualizada com sucesso! Recarregando a página do dashboard";

                    setTimeout(() => {
                        window.location = "dashboard.html";
                    }, "2000");

                    limparFormulario();
                    finalizarAguardar();
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                finalizarAguardar();
            });

        return false;
    }

    function sumirMensagem() {
        cardErro.style.display = "none";
    }
</script>