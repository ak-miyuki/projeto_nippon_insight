<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icons/mt_fuji_img.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>『日本』Nippon Insight | Dashboards</title>


    <link rel="stylesheet" href="./../css/dashboards.css">
    <!-- <link rel="stylesheet" href="./../css/estilo.css" /> -->
    <!-- <link rel="stylesheet" href="./../css/style.css" /> -->
    <script src="../js/sessao.js"></script>
    <!-- <script src="./../js/alerta.js"></script> -->


    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body onload="atualizarPagina()">

    <!------------------------------- HEADER ------------------------------->
    <div class="header">
        <div class="container">
            <h1 class="titulo">『日本』Nippon Insight</h1>
            <ul class="navbar">
                <li>
                    <a href="./dashboard.html">DASHBOARD</a>
                </li>
                <li> | </li>
                <li>
                    <a href="./viagem.html">EDITAR VIAGEM</a>
                </li>
                <li> | </li>
                <li class="agora">
                    <a href="#">ESCOLHAS</a>
                </li>

            </ul>
            <div class="nome-sair">
                <div class="hello">
                    <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
                </div>
                <div>
                    <button class="botao-preto" onclick="limparSessao()">SAIR</button>
                </div>
            </div>

        </div>
    </div>
    <!----------------------------- HEADER END ----------------------------->

    <div class="janela">
        <div class="header-left_escolhas">
            <div class="menu_titulo">
                <h1>Lista de Escolhas</h1>
            </div>

            <div class="conteudo">
                <!-- COLOCAR OS CONTEÚDOS DO MENU -->

                <!-- CIDADES -->
                <div class="menu_block">
                    <h3>&#x1F338; CIDADES:</h3>
                    <span id="span_cidades"> --//-- </span>
                </div>

                <!-- INGRESSOS -->
                <div class="menu_block">
                    <h3>&#x1F338; INGRESSOS:</h3>
                    <span id="span_ingressos"> --//-- </span>
                </div>

                <!-- ALIMENTAÇÃO -->
                <div class="menu_block">
                    <h3>&#x1F338; ALIMENTAÇÃO:</h3>
                    <span id="span_alimentacao"> --//-- </span>
                </div>

                <!-- HOSPEDAGEM -->
                <div class="menu_block">
                    <h3>&#x1F338; HOSPEDAGEM:</h3>
                    <span id="span_hospedagem"> --//-- </span>
                </div>

                <!-- TRANSPORTE -->
                <div class="menu_block">
                    <h3>&#x1F338; TRANSPORTE</h3>
                    <span id="span_transporte"> --//-- </span>
                </div>

                <!-- COMUNICAÇÃO -->
                <div class="menu_block">
                    <h3>&#x1F338; COMUNICAÇÃO:</h3>
                    <span id="span_comunicacao"> --//-- </span>
                </div>

            </div>

        </div>

        <div class="opcoes" id="div_escolhas">
            <div id="div_categoria">
                <div class="categoria" id="div_tipo">
                    <h1>${item.categoria}</h1>
                </div>
                <div class="conteudo_info">
                    <div class="foto">
                        <span id="span_foto">${item.foto}</span>
                    </div>
                    <div id="div_info" class="info">
                        <div id="div_nome">
                            <h3>
                                <span id="span_nome">${item.nome}</span>
                            </h3>
                        </div>
                        <div id="div_descricao">
                            <h3>Descrição:</h3>
                            <span id="span_descricao">${item.descricao}</span>
                        </div>
                    </div>
                    <div class="input_qtd">
                        <h3>Preço unitário:</h3>
                        <span id="span_preco">${item.preco}</span>
                        <h3>Quantidade:</h3>
                        <input type="text" id="input_preco${item.idItem}">
                        <button class="botao" onclick="adicionar()">ADICIONAR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    var idViagem = JSON.parse(sessionStorage.VIAGEM).idViagem;

    function atualizarPagina() {

        var horas_voo = 50;
        span_horas_voo.innerHTML = `~${horas_voo} HORAS`;

        fetch(`/viagem/${sessionStorage.ID_USUARIO}`)
            .then(response => response.json())
            .then(listaViagem => {

                span_estacao.innerHTML = listaViagem[0].estacao;
                span_dt_ida.innerHTML = listaViagem[0].dtIda;
                span_dt_volta.innerHTML = listaViagem[0].dtVolta;
                span_dias_japao.innerHTML = listaViagem[0].diasJapao;
                span_qtd_pessoas.innerHTML = listaViagem[0].qtdPessoas;
                valor_guardado = Number(listaViagem[0].valorGuardado);
                span_valor_guardado.innerHTML = valor_guardado.toLocaleString('pt-BR', { style: "currency", currency: 'BRL' });
                valorTotal = Number(listaViagem[0].valorTotal);
                span_valor_viagem.innerHTML = valorTotal.toLocaleString('pt-BR', { style: "currency", currency: 'BRL' });
                var progresso = listaViagem[0].percentualGuardado;
                porcentagem_progresso.innerHTML = `${progresso}%`;
                barra_porcentagem.style.width = `${progresso}%`;

            })
            .catch(error => console.error('Erro ao buscar dados:', error));

        if (idViagem == null) {
            div_container_pizza.style.display = "none";
        }

        function plotarGraficoPizza() {

            Chart.defaults.font.family = 'Montserrat';
            Chart.defaults.color = '#e3b062';

            fetch(`/escolhas/${idViagem}`, { cache: 'no-store' })
                .then(response => response.json())
                .then(dados => {



                    var categorias = [];
                    var valores = [];

                    for (var i = 0; i < dados.length; i++) {
                        categorias.push(dados[i].categoria);
                        valores.push(dados[i].valorTotal);
                    }



                    var ctx = document.getElementById("grafico_pizza").getContext("2d");

                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: categorias,
                            datasets: [{
                                data: valores,
                                backgroundColor: [
                                    '#741c32',
                                    '#e3b062',
                                    '#bd6088',
                                    '#dfd4be'

                                ],
                                borderColor: '#c4b28b',
                                borderWidth: 2
                            }]
                        },
                        plugins: [ChartDataLabels],
                        options: {
                            responsive: true,
                            aspectRatio: 1.2,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                })
                .catch(erro => console.error("Erro no gráfico:", erro));

        }

        plotarGraficoPizza();









    }

    function atualizarCaixinha() {

        fetch(`/viagem/${sessionStorage.ID_USUARIO}`)
            .then(response => response.json())
            .then(listaViagem => {

                // pegar valor atual
                var novoValorGuardadoVar = Number(listaViagem[0].valorGuardado);

                // pegar input
                var caixinha = Number(caixinha_input.value);

                // somar
                novoValorGuardadoVar += caixinha;

                // enviar ao banco
                fetch("/viagem/atualizarCaixinha", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        novoValorGuardadoServer: novoValorGuardadoVar,
                        idUsuarioServer: sessionStorage.ID_USUARIO
                    }),
                })
                    .then(function (resposta) {
                        console.log("resposta: ", resposta);

                        if (resposta.ok) {
                            cardErro.style.display = "block";

                            mensagem_erro.innerHTML =
                                "Caixinha atualizada com sucesso! Recarregando a página do dashboard";

                            setTimeout(() => {
                                window.location = "dashboard.html";
                            }, "2000");

                            limparFormulario();
                            finalizarAguardar();
                        } else {
                            throw "Houve um erro ao tentar realizar o cadastro!";
                        }
                    })
                    .catch(function (resposta) {
                        console.log(`#ERRO: ${resposta}`);
                        finalizarAguardar();
                    });

            })
            .catch(error => console.error('Erro ao buscar dados:', error));

        setTimeout(() => {

            atualizarPagina();
        }, "2000");

        return false;

    }


    function sumirMensagem() {
        cardErro.style.display = "none";
    }
</script>